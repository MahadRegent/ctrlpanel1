# Оптимизация загрузки тарифов - Устранение API вызовов к Pterodactyl

## Проблема
Загрузка тарифов занимала до 30 секунд из-за множественных API вызовов к Pterodactyl для каждого продукта и ноды при:
- Загрузке страницы серверов
- Проверке доступных ресурсов
- Получении опций для апгрейда
- Отображении overview админ панели

## Решение
Реализована система кеширования ресурсов нод и информации о серверах в локальной базе данных.

## Изменения в базе данных

### 1. Таблица `nodes` - добавлены поля:
- `memory` - общий объем памяти ноды
- `disk` - общий объем диска ноды  
- `memory_overallocate` - процент превышения памяти
- `disk_overallocate` - процент превышения диска
- `allocated_resources` - JSON с используемыми ресурсами
- `resource_updated_at` - время последнего обновления кеша

### 2. Таблица `servers` - использованы существующие поля:
- `cached_location` - кешированное название локации
- `cached_egg` - кешированное название egg
- `cached_nest` - кешированное название nest
- `cached_node` - кешированное название ноды
- `cache_updated_at` - время последнего обновления кеша

## Модифицированные файлы

### 1. `/app/Models/Pterodactyl/Node.php`
- Обновлен метод `syncNodes()` для сохранения ресурсной информации
- Добавлены методы для локальной проверки ресурсов:
  - `hasAvailableResources($memory, $disk)` - проверка доступности ресурсов
  - `getAvailableMemory()` - получение доступной памяти
  - `getAvailableDisk()` - получение доступного диска
  - `getUsagePercent()` - получение процента использования

### 2. `/app/Http/Controllers/ProductController.php`
- `getLocationsBasedOnEgg()` - убраны API вызовы, используются кешированные данные
- `getProductsBasedOnLocation()` - заменены API вызовы на локальные методы

### 3. `/app/Http/Controllers/ServerController.php`
- `getServersWithInfo()` - добавлено кеширование информации о серверах (1 час)
- `updateServerInfo()` - обновлен для сохранения кеша
- `findAvailableNode()` - использует локальные данные вместо API
- `getUpgradeOptions()` - убраны API вызовы к ресурсам нод
- `validateUpgrade()` - использует кешированные данные для проверки ресурсов

### 4. `/app/Http/Controllers/Admin/OverViewController.php`
- Убраны множественные API вызовы для получения usage нод
- Используется метод `getUsagePercent()` из кеша

## Новые команды Artisan

### 1. `nodes:sync-resources`
**Файл:** `/app/Console/Commands/SyncNodeResources.php`
**Назначение:** Синхронизация ресурсной информации всех нод
**Расписание:** каждые 5 минут

### 2. `servers:sync-info`  
**Файл:** `/app/Console/Commands/SyncServerInfo.php`
**Назначение:** Синхронизация информации о серверах (локация, egg, nest, нода)
**Расписание:** каждые 15 минут

## Миграции

### `/database/migrations/2025_01_20_120000_add_resource_cache_to_nodes_table.php`
Добавляет поля кеширования ресурсов в таблицу `nodes`.

## Расписание (Scheduler)
В `/app/Console/Kernel.php` добавлены автоматические задачи:
- Синхронизация ресурсов нод: каждые 5 минут
- Синхронизация информации серверов: каждые 15 минут

## Преимущества

### 1. Производительность
- **До:** загрузка тарифов до 30 секунд
- **После:** загрузка тарифов меньше 1 секунды (только локальные запросы)

### 2. Снижение нагрузки
- Устранены сотни API вызовов к Pterodactyl при каждой загрузке
- API используется только для периодической синхронизации

### 3. Надежность
- Система продолжает работать даже при временной недоступности Pterodactyl API
- Graceful fallback при отсутствии кешированных данных

### 4. Актуальность данных
- Ресурсы нод обновляются каждые 5 минут
- Информация о серверах обновляется каждые 15 минут
- Кешированные данные сервера действительны 1 час

## Совместимость
- Все изменения обратно совместимы
- При отсутствии кешированных данных система использует старый метод с API
- Существующий функционал не нарушен

## Тестирование
После применения изменений рекомендуется:
1. Запустить миграцию: `php artisan migrate`
2. Выполнить первоначальную синхронизацию: `php artisan nodes:sync-resources`
3. Синхронизировать серверы: `php artisan servers:sync-info`
4. Проверить работу scheduler: `php artisan schedule:list`
5. Протестировать загрузку страниц с тарифами

## Мониторинг
Команды синхронизации логируют свою работу. Рекомендуется отслеживать:
- Время выполнения команд синхронизации
- Ошибки подключения к Pterodactyl API
- Актуальность кешированных данных (`resource_updated_at`, `cache_updated_at`)